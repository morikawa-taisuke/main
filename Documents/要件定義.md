# 📝 プロジェクト「PySurfer」(仮称) 設計ドキュメント

このドキュメントは、デスクトップアプリケーション「WaveSurfer」の主要機能をPythonで再現するために必要な要件、技術選定、および開発計画を定義するものです。

### 1\. プロジェクト概要

  * **目的:**
      * WaveSurferの核となる機能（音声の視覚化、アノテーション）を持つ、クロスプラットフォーム（Windows, macOS, Linux）のデスクトップアプリケーションをPythonで開発する。
      * オリジナルのTcl/Tkベースではなく、現代的でメンテナンス性の高いPythonスタックで構築する。
  * **スコープ（範囲）:**
      * **[IN] 対象:**
          * 音声ファイル（WAV, RAW）の読み込み。
          * 波形、スペクトログラムの表示。
          * タイムライン連動型のアノテーション（ラベル付け）機能。
          * 波形・スペクトログラム画像のファイル保存機能。
      * **[OUT] 対象外 (初期リリース):**
          * ピッチ（$F_0$）の表示・分析。
          * オリジナルの持つ高度なスクリプティング機能、プラグイン機構。
  * **ターゲットユーザー:**
      * 音声学者、音響学者
      * 音声処理を学ぶ学生・研究者
      * 機械学習のための音声データにアノテーションを行う人

-----

### 2\. 機能要件

#### 2.1. ファイルI/O

  * 音声ファイルを読み込めること
    (\<code\>File \> Open\</code\>)。
      * **必須: WAV** (16-bit, 24-bit, 32-bit float)
      * **必須: RAW (.raw, .pcm など)**
          * RAWファイル選択時、メタデータ（**サンプリングレート**, **データ型** (例: `int16`, `float32`), **チャンネル数**）をユーザーが指定できるダイアログを表示すること。
      * 推奨: MP3, FLAC
  * アノテーションデータを読み込み・保存できること。
      * 必須: PraatのTextGrid形式（互換性のため強く推奨）
      * 推奨: シンプルなCSV形式 (\<code\>start\_time, end\_time, label\</code\>)

#### 2.2. 画像エクスポート 🖼️

  * **必須:** 現在表示されている**波形ペイン**、または**スペクトログラムペイン**を画像ファイルとして保存できること 
  (\<code\>File \> Export Image...\</code\>)。
  * **必須:** 保存ダイアログで**任意のファイル名**と形式（PNG, JPEG）を指定できること。
  * 推奨: 現在表示されているビュー全体（全ペイン）を一つの画像として保存できること。

#### 2.3. 音声再生 🎶

  * 音声全体を再生・一時停止・停止できること。
  * 選択した範囲（リージョン）を再生できること。
  * 推奨: ループ再生機能。

#### 2.4. 視覚化（表示ペイン） 📊

  * 複数のペイン（パネル）を縦に並べて表示できること。
  * 全てのペインは、水平方向（時間軸）に連動してスクロール・ズームできること。
  * **波形 (Waveform) ペイン:**
      * 音声の振幅波形を表示する。
      * 垂直方向のズーム（振幅の拡大・縮小）ができること。
  * **スペクトログラム (Spectrogram) ペイン:**
      * 短時間フーリエ変換 (STFT) に基づくスペクトログラムを表示する。
      * パラメータ（FFTサイズ、ウィンドウ関数、オーバーラップ率）を変更できること。
      * 推奨: 周波数帯域のズーム、カラースケールの変更。

#### 2.5. インタラクションとアノテーション ✍️

  * **ナビゲーション:**
      * マウスドラッグによる水平スクロール（パン）。
      * マウスホイールによる水平ズーム（時間軸の拡大・縮小）。
      * \<code\>Zoom In\</code\> / \<code\>Zoom Out\</code\> / \<code\>Zoom to Selection\</code\> / \<code\>Zoom All\</code\> ボタン。
  * **選択:**
      * マウスのドラッグ操作で、波形やスペクトログラム上の時間範囲を選択できること。
      * 選択範囲の開始・終了時刻が表示されること。
  * **アノテーション・ペイン:**
      * TextGridのような「ティア」（Tier）を管理できること。
      * **インターバル・ティア:** 選択範囲にラベル（テキスト）を挿入できること。
      * **ポイント・ティア:** 特定の時間点にラベルを挿入できること。
      * 挿入したラベルの境界線をマウスでドラッグして調整できること。
      * ラベル内をダブルクリックしてテキストを編集できること。

-----

### 3\. 技術スタック（使用ライブラリ案） 💻

  * **UIフレームワーク (GUI):**
      * **PyQt (または PySide):** 最も有力な選択肢。複雑なUI、高速な描画、クロスプラットフォームに最適。
  * **音声ファイルの読み込み:**
      * **Librosa / SoundFile:** WAV, FLAC, MP3などに幅広く対応。リサンプリングも容易。
      * **NumPy (`np.fromfile`):** RAWファイルのバイナリ読み込みに**必須**。
  * **数値計算 (データ処理):**
      * **NumPy:** 必須。音声データ（サンプルの配列）を扱うための基本。
  * **音声処理 (STFT):**
      * **Librosa:** STFT（スペクトログラム生成）に便利。
      * **SciPy (`scipy.signal`):** STFTやウィンドウ関数など、より低レベルな制御も可能。
  * **プロット (視覚化):**
      * **PyQtGraph:** **(強く推奨)** PyQt/PySideに特化。大規模データ（音声サンプル）のインタラクティブな描画が非常に高速。ウィジェットを**画像としてエクスポートする機能 (`export`)** も持つため、2.2の要件に最適。
  * **音声再生:**
      * **Sounddevice:** シンプルかつ低レイヤーで、NumPy配列を直接再生できるため、選択範囲再生などの制御に適している。

-----

### 4\. アーキテクチャ設計 (MVC)

UIとロジックを分離するために、**Model-View-Controller (MVC)** パターンを採用することを推奨します。

  * **Model (モデル):**
      * 音声データ (NumPy配列)、サンプリングレート、アノテーションデータ（ラベルのリスト）を保持する。
      * RAWファイルの場合、ユーザーが指定したメタデータ（サンプリングレート、型、チャンネル数）も保持する。
      * 音声処理（STFT）ロジック、ファイルI/Oロジックを担当する。
  * **View (ビュー):**
      * PyQtで構築されたGUIウィンドウ、ボタン、スライダー。
      * PyQtGraphで構築されたプロット領域（波形、スペクトログラム）。
      * RAW設定ダイアログ、画像保存ダイアログの表示を担当する。
  * **Controller (コントローラ):**
      * Viewからのイベント（例: 「再生ボタンが押された」「画像保存メニューが選択された」）を受け取る。
      * `File > Open` でRAWファイルが選択された場合、Viewに「メタデータ入力ダイアログ」の表示を指示する。
      * 「画像保存」が選択されたら、View（対象のPyQtGraphウィジェット）に画像のエクスポートを命令し、保存ダイアログを表示する。
      * Modelを更新し、Modelの変更をViewに通知して表示を更新させる。

-----

### 5\. 開発ロードマップ (MVP)

  * **フェーズ1: 基本表示 (MVP)**
    1.  PyQtでメインウィンドウを作成する。
    2.  「ファイルを開く」ダイアログで**WAV**ファイルを読み込む (Librosa)。
    3.  PyQtGraphで読み込んだ波形データを表示する。
  * **フェーズ2: 基本操作**
    1.  Sounddeviceで音声データを再生・停止する機能を追加する。
    2.  PyQtGraphの機能で、波形のズーム（ホイール）とパン（ドラッグ）を実装する。
  * **フェーズ3: コア機能の実装**
    1.  波形ペインの下に、スペクトログラム用のペインを追加し、両ペインの時間軸を連動させる。
    2.  メニューバーに「画像として保存」アクションを追加し、PyQtGraphの`export`機能を呼び出す。
    3.  **RAWファイル**の読み込み機能（メタデータ入力ダイアログと`np.fromfile`処理）を実装する。
  * **フェーズ4: アノテーション**
    1.  アノテーションペインを追加し、マウスドラッグでの時間範囲選択を実装する。
    2.  ラベルの追加・編集ロジックを実装する。
    3.  Praat TextGrid形式での保存・読み込みを実装する。
  * **フェーズ5: ポリッシュ**
    1.  Zoomボタン（Zoom In/Out など）の実装。
    2.  推奨機能（MP3読み込み、ループ再生など）の追加。